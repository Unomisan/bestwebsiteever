AUTHOR_NAME = sh (
  script: "git show -s | grep Author | awk '{print \$2 " " \$3}'",
  returnStdout: true
)

GIT_COMMIT_HASH = sh (
  script: "git log -n 1 --pretty=format:'%H'", 
  returnStdout: true
)

COMMIT_MESSAGE = sh (
  script: "git log --format=%B -n 1 HEAD",
  returnStdout: true
)

pipeline {
  agent {
    label 'helm-slave'
  }
  stages {

    stage('Starting pipeline run') {
      steps {
        slackSend (color: '#FFFF00', message: "${AUTHOR_NAME} STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' ${COMMIT_MESSAGE} -- ${GIT_COMMIT_HASH} (${env.BUILD_URL})")
      }
    }
    stage('helm init') {
      steps {
        sh """
          helm lint helm/artsncrafts/
        """
      }
    }
    stage('helm dry run'){
      steps {
        sh """
          helm install -f helm/artsncrafts/values.yaml helm/artsncrafts/ --dry-run --debug 
        """
      }
    }
    stage('helm deploy'){
      steps {
        sh """
          helm install -f  helm/artsncrafts/values.yaml helm/artsncrafts/ --namespace dev --debug
        """
      }
    }
  }
  post {
    success {
      slackSend (color: '#00FF00', message: "Commit SUCCESSFUL ${GIT_COMMIT_HASH}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' ${COMMIT_MESSAGE} -- ${GIT_COMMIT_HASH} (${env.BUILD_URL}), way to be a hero ${AUTHOR_NAME}")
    }

    failure {
      slackSend (color: '#FF0000', message: "Commit FAILED ${GIT_COMMIT_HASH}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'${COMMIT_MESSAGE} -- ${GIT_COMMIT_HASH} (${env.BUILD_URL}) Looking at you $AUTHOR_NAME}")
    }
  }
}